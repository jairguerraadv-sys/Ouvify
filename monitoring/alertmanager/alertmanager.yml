# Alertmanager Configuration
# ==========================
# Configura√ß√£o de notifica√ß√µes de alertas

global:
  # Configura√ß√£o de SMTP para envio de emails
  smtp_smarthost: '${SMTP_HOST:-smtp.gmail.com}:${SMTP_PORT:-587}'
  smtp_from: '${SMTP_FROM:-alertas@ouvy.com.br}'
  smtp_auth_username: '${SMTP_USER}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

  # Configura√ß√£o de Slack (opcional)
  slack_api_url: '${SLACK_WEBHOOK_URL}'

# Templates personalizados
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Roteamento de alertas
route:
  # Agrupa alertas com mesmas labels
  group_by: ['alertname', 'service', 'severity']
  
  # Tempo de espera antes de enviar grupo
  group_wait: 30s
  
  # Tempo entre notifica√ß√µes do mesmo grupo
  group_interval: 5m
  
  # Tempo para reenviar alerta n√£o resolvido
  repeat_interval: 4h
  
  # Receptor padr√£o
  receiver: 'default-receiver'
  
  # Rotas espec√≠ficas
  routes:
    # Alertas cr√≠ticos v√£o para todos os canais
    - match:
        severity: critical
      receiver: 'critical-alerts'
      continue: true

    # Alertas de seguran√ßa
    - match:
        service: security
      receiver: 'security-alerts'
      continue: true

    # Alertas de banco de dados
    - match:
        service: database
      receiver: 'database-alerts'

# Receptores de notifica√ß√£o
receivers:
  # Receptor padr√£o (email)
  - name: 'default-receiver'
    email_configs:
      - to: '${ALERT_EMAIL:-devops@ouvy.com.br}'
        send_resolved: true
        headers:
          Subject: '[OUVY] {{ .Status | toUpper }}: {{ .CommonLabels.alertname }}'
        html: |
          <h2>{{ .Status | toUpper }}: {{ .CommonLabels.alertname }}</h2>
          <p><strong>Severidade:</strong> {{ .CommonLabels.severity }}</p>
          <p><strong>Servi√ßo:</strong> {{ .CommonLabels.service }}</p>
          {{ range .Alerts }}
          <hr>
          <p><strong>Descri√ß√£o:</strong> {{ .Annotations.description }}</p>
          <p><strong>In√≠cio:</strong> {{ .StartsAt }}</p>
          {{ if .EndsAt }}
          <p><strong>Fim:</strong> {{ .EndsAt }}</p>
          {{ end }}
          {{ end }}

  # Alertas cr√≠ticos (email + Slack)
  - name: 'critical-alerts'
    email_configs:
      - to: '${CRITICAL_ALERT_EMAIL:-oncall@ouvy.com.br}'
        send_resolved: true
    slack_configs:
      - channel: '#ouvy-alerts'
        send_resolved: true
        title: '{{ if eq .Status "firing" }}üö®{{ else }}‚úÖ{{ end }} {{ .CommonLabels.alertname }}'
        text: |
          *Status:* {{ .Status | toUpper }}
          *Severidade:* {{ .CommonLabels.severity }}
          *Servi√ßo:* {{ .CommonLabels.service }}
          {{ range .Alerts }}
          *Descri√ß√£o:* {{ .Annotations.description }}
          {{ end }}
        actions:
          - type: button
            text: 'Ver no Grafana'
            url: '${GRAFANA_URL:-http://localhost:3001}'

  # Alertas de seguran√ßa
  - name: 'security-alerts'
    email_configs:
      - to: '${SECURITY_EMAIL:-security@ouvy.com.br}'
        send_resolved: true
    slack_configs:
      - channel: '#ouvy-security'
        send_resolved: true
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        title: 'üîê {{ .CommonLabels.alertname }}'
        text: |
          *Alerta de Seguran√ßa*
          {{ range .Alerts }}
          {{ .Annotations.description }}
          {{ end }}

  # Alertas de banco de dados
  - name: 'database-alerts'
    email_configs:
      - to: '${DBA_EMAIL:-dba@ouvy.com.br}'
        send_resolved: true

# Inibi√ß√£o de alertas (evita flood)
inhibit_rules:
  # Se API est√° down, n√£o enviar alerta de lat√™ncia
  - source_match:
      alertname: 'APIDown'
    target_match:
      alertname: 'HighAPILatency'
    equal: ['service']

  # Se Redis est√° down, n√£o enviar alerta de mem√≥ria
  - source_match:
      alertname: 'RedisDown'
    target_match:
      alertname: 'RedisHighMemory'
    equal: ['service']
