#!/bin/sh
# Husky pre-push hook
# Executa testes antes de push para branches protegidas

# Branch atual
branch=$(git rev-parse --abbrev-ref HEAD)

# Branches protegidas que exigem testes
protected_branches="main master develop staging production"

# Verifica se Ã© uma branch protegida
is_protected=false
for protected in $protected_branches; do
    if [ "$branch" = "$protected" ]; then
        is_protected=true
        break
    fi
done

if [ "$is_protected" = true ]; then
    echo "ğŸ” Branch protegida detectada: $branch"
    echo "ğŸ§ª Executando testes antes do push..."
    echo ""
    
    # Executa type-check
    echo "ğŸ“ Verificando tipos TypeScript..."
    npm run type-check
    if [ $? -ne 0 ]; then
        echo "âŒ Type-check falhou. Push abortado."
        exit 1
    fi
    
    # Executa lint
    echo "ğŸ” Executando lint..."
    npm run lint
    if [ $? -ne 0 ]; then
        echo "âŒ Lint falhou. Push abortado."
        exit 1
    fi
    
    # Executa testes
    echo "ğŸ§ª Executando testes..."
    npm run test:frontend -- --passWithNoTests
    if [ $? -ne 0 ]; then
        echo "âŒ Testes falharam. Push abortado."
        exit 1
    fi
    
    echo ""
    echo "âœ… Todas as verificaÃ§Ãµes passaram!"
fi
